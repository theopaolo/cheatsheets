---
import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
	const sheets = await getCollection('sheets');
	return sheets.map((sheet) => ({
		params: { slug: sheet.slug },
		props: { sheet },
	}));
}

interface Props {
	sheet: CollectionEntry<'sheets'>;
}

const { sheet } = Astro.props;
const { Content } = await sheet.render();
---

<Layout title={sheet.data.title} description={sheet.data.description}>
	<div class="sheet-overlay" id="overlay">
		<div class="sheet-detail" id="sheet-detail" transition:name={`sheet-detail`}>
			<nav class="back-nav no-print">
				<a href="/" class="back-link">‚Üê Back to all cheatsheets</a>
			</nav>

			<article class="sheet-content">
				<header class="sheet-header">
					<h1>{sheet.data.title}</h1>
					<p class="sheet-description">{sheet.data.description}</p>
					{sheet.data.tags && (
						<div class="tags">
							{sheet.data.tags.map((tag) => (
								<span class="tag">{tag}</span>
							))}
						</div>
					)}
				</header>

				<div class="sheet-body">
					<Content />
				</div>
			</article>
		</div>
	</div>
</Layout>

<script>
	// Navigate back to homepage on Escape key
	function handleEscape(event: KeyboardEvent) {
		if (event.key === 'Escape') {
			window.location.href = '/';
		}
	}

	// Navigate back when clicking outside the sheet
	function handleOverlayClick(event: MouseEvent) {
		const overlay = document.getElementById('overlay');
		const sheetDetail = document.getElementById('sheet-detail');

		if (overlay && sheetDetail && event.target === overlay) {
			window.location.href = '/';
		}
	}

	// Add event listeners
	document.addEventListener('keydown', handleEscape);
	document.getElementById('overlay')?.addEventListener('click', handleOverlayClick);

	// Clean up on navigation (for View Transitions)
	document.addEventListener('astro:before-preparation', () => {
		document.removeEventListener('keydown', handleEscape);
		document.getElementById('overlay')?.removeEventListener('click', handleOverlayClick);
	});
</script>

<style>
	.sheet-overlay {
		min-height: 100vh;
		padding: var(--space-4);
		background-color: rgba(0, 0, 0, 0.02);
		cursor: pointer;
	}

	.sheet-detail {
		max-width: var(--content-max);
		margin-inline: auto;
		background-color: var(--color-white);
		border: 1px solid var(--color-border);
		padding: var(--space-6);
		cursor: auto;
	}

	.back-nav {
		margin-block-end: var(--space-6);
		padding-block-end: var(--space-4);
		border-bottom: 1px solid var(--color-border);
	}

	.back-link {
		display: inline-block;
		font-size: var(--font-size-sm);
		color: var(--color-text-muted);
		text-decoration: none;
		transition: color var(--transition-fast);
	}

	.back-link:hover {
		color: var(--color-text);
	}

	.back-link:focus-visible {
		outline: 2px solid var(--color-black);
		outline-offset: 2px;
	}

	.sheet-header {
		margin-block-end: var(--space-8);
		padding-block-end: var(--space-6);
		border-bottom: 2px solid var(--color-black);
	}

	.sheet-header h1 {
		font-size: var(--font-size-2xl);
		margin-block-end: var(--space-3);
		font-weight: 600;
	}

	.sheet-description {
		font-size: var(--font-size-md);
		color: var(--color-text-muted);
		margin-block-end: var(--space-4);
	}

	.tags {
		display: flex;
		flex-wrap: wrap;
		gap: var(--space-2);
		margin-block-start: var(--space-4);
	}

	.tag {
		font-size: var(--font-size-xs);
		padding: var(--space-1) var(--space-3);
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.sheet-body {
		line-height: var(--line-height-relaxed);
	}

	.sheet-body :global(h1) {
		font-size: var(--font-size-xl);
		margin-block: var(--space-8) var(--space-4);
		font-weight: 600;
	}

	.sheet-body :global(h2) {
		font-size: var(--font-size-lg);
		margin-block: var(--space-6) var(--space-3);
		font-weight: 600;
		padding-block-start: var(--space-4);
		border-top: 1px solid var(--color-border);
	}

	.sheet-body :global(h3) {
		font-size: var(--font-size-md);
		margin-block: var(--space-4) var(--space-2);
		font-weight: 600;
	}

	.sheet-body :global(p) {
		margin-block-end: var(--space-4);
	}

	.sheet-body :global(ul),
	.sheet-body :global(ol) {
		margin-block-end: var(--space-4);
		padding-inline-start: var(--space-6);
	}

	.sheet-body :global(li) {
		margin-block-end: var(--space-2);
	}

	.sheet-body :global(code) {
		background-color: var(--color-surface);
		padding: var(--space-1) var(--space-2);
		font-size: 0.9em;
		border: 1px solid var(--color-border);
	}

	.sheet-body :global(pre) {
		background-color: var(--color-surface);
		border: 1px solid var(--color-border);
		padding: var(--space-4);
		overflow-x: auto;
		margin-block: var(--space-4);
		line-height: 1.6;
	}

	.sheet-body :global(pre code) {
		background: none;
		border: none;
		padding: 0;
	}

	.sheet-body :global(a) {
		text-decoration: underline;
		text-decoration-thickness: 1px;
		text-underline-offset: 2px;
		transition: text-decoration-thickness var(--transition-fast);
	}

	.sheet-body :global(a:hover) {
		text-decoration-thickness: 2px;
	}

	@media (min-width: 48em) {
		.sheet-overlay {
			padding: var(--space-12);
		}

		.sheet-detail {
			padding: var(--space-12);
		}

		.back-nav {
			margin-block-end: var(--space-8);
		}
	}

	@media print {
		.sheet-overlay {
			background: var(--color-white);
			padding: 0;
		}

		.sheet-detail {
			border: none;
			max-width: 100%;
			padding: 0;
		}

		.sheet-header {
			border-bottom: 2pt solid var(--color-black);
		}
	}
</style>
